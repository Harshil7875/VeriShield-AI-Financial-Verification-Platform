# **Notebook: `02-Model-Training-GNN-PyTorch-3.ipynb`** 

## **Overview & Purpose**

This notebook demonstrates **multi-task** GNN training on the **VeriShield** processed GNN data, including:

1. **Three Node Types**: **users**, **businesses**, and **IPs**.  
2. **Multi-Edge Relationships**: `user->user`, `user->business`, `user->ip`, plus reverse edges for **bidirectional** message passing.  
3. **Multi-Task Classification**: The model predicts **user fraud**, **business fraud**, and optionally **IP** suspiciousness in a single forward pass.  

### **Key Goals**

- **Load** the `.npy` arrays (user/business/IP features, labels, edges, masks) generated by the `02-GNN-DataPrep-EDA-2.ipynb` notebook  
- **Build** a hetero-graph in **PyTorch Geometric** (`HeteroData` object).  
- **Define** a multi-edge, multi-task GNN (`FraudGNN`) that aggregates messages across user–user, user–business, user–ip edges.  
- **Train** with combined losses (user + business + IP), if desired.  
- **Evaluate** final user, business, and IP classification accuracy on test masks.

---

## **Notebook Structure**

1. **Cell 1: Imports & Setup**  
   - Imports PyTorch, PyG modules, sets `device` to GPU if available.  
2. **Cell 2: Configuration**  
   - Paths, hyperparameters, and flags (`MULTI_TASK`, `IP_CLASSIFICATION`).  
3. **Cell 3: Loading `.npy` Arrays**  
   - Reads features (`user_features.npy`, etc.), labels, edges, and train/val/test masks for all node types.  
   - Prints shapes and metadata for quick validation.  
4. **Cell 4: Construct HeteroData**  
   - Creates node sets (`data['user']`, `data['business']`, `data['ip']`) and assigns features & labels.  
   - Adds edges for user–user, user–business, user–ip, plus reversed edges (e.g., `business->rev_user_business->user`).  
   - Moves `data` to `device`.  
5. **Cell 5: Define `FraudGNN`**  
   - Uses **HeteroConv** with `SAGEConv` for each edge relation.  
   - Provides separate linear heads for user, business, and IP outputs if `MULTI_TASK` or `IP_CLASSIFICATION` is enabled.  
6. **Cell 6: Training Setup**  
   - An `optimizer` (Adam) and `train_step()` function that computes combined losses: user + business + IP.  
   - Separate `evaluate_user()`, `evaluate_biz()`, and `evaluate_ip()` methods for masked accuracy checks.  
7. **Cell 7: Main Training Loop**  
   - Runs multiple epochs, each with repeated gradient steps (`STEPS_PER_EPOCH`).  
   - Prints training loss and validation accuracy for user/business/IP each epoch.  
   - Final test accuracy is printed at the end.  
8. **Cell 8: Wrap-Up**  
   - Summarizes the approach, edges, node types, and final results.

---

## **Final Results**

In the run shown, the notebook achieved:

1. **User**  
   - **Test Accuracy**: ~**74.70%**  
   - This aligns with a scenario where ~75% of users are labeled fraud.  
2. **Business**  
   - **Test Accuracy**: ~**97.13%**  
   - Very high accuracy, likely due to strong synergy or heavy skew (most businesses are fraud).  
3. **IP**  
   - **Test Accuracy**: **100.00%**  
   - Suggests IP labeling may be trivial (e.g., all suspicious IPs share a single indicator), or IP synergy is very strong.  

> **Interpretation**:  
> - With the **`medium_fraud`** scenario and synergy-based data, the model easily classifies IPs (possibly an all-or-nothing label).  
> - Businesses also show high accuracy (around 97%). This could be a sign that the dataset is heavily skewed toward fraudulent businesses, making them easy to detect.  
> - User accuracy is around 74–75%, matching the high fraud ratio in user data.

**Next Steps**:

- **Refine** synergy factors if the dataset is too skewed (e.g., 74% user fraud, 97% business fraud).  
- **Track** precision/recall or confusion matrices for a more nuanced picture of performance under heavy skew.  
- **Experiment** with deeper or alternative GNN architectures (e.g., GATConv, RGCN) or **mini-batch** training for scalability.

---

## **Usage**

1. **Ensure** you’ve generated data with `SINGLE_TASK_USER_ONLY=False` (to get business masks) and `IP_CLASSIFICATION=True` (for IP labels/masks).  
2. **Update** `PROCESSED_DIR` in **Cell 2** to your local scenario path, e.g. `data/medium_fraud/processed_gnn`.  
3. **Select** hyperparameters (`HIDDEN_DIM`, `EPOCHS`, etc.).  
4. **Run** cells in order.  
5. **Observe** final user, business, and IP test accuracies.

---

## **Conclusion**

**`02-Model-Training-GNN-PyTorch-3.ipynb`** demonstrates a **multi-edge, multi-task** GNN approach in PyTorch Geometric, handling user/business/IP classification in one forward pass. The final user, business, and IP accuracies reflect your synergy-based data distribution. Adjust synergy or labeling logic if you need less skewed, more challenging sets. Otherwise, these results confirm that **one GNN** can learn from **all** node types and edges simultaneously, capturing ring-based, multi-owner, and IP collision fraud patterns.